name: CD-Pipeline (Phase 3)

on:
  push:
    branches: [ main ]

env:
  # --- CHECK THESE VALUES CAREFULLY ---
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: mlops-cluster
  GKE_ZONE: us-central1-a # <-- CHANGE THIS if your cluster is in a different zone
  AR_HOST: us-central1-docker.pkg.dev # <-- CHANGE THIS if your registry is in a different region
  AR_REPO: mlops-repo
  # ------------------------------------

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Build and Push Docker Image
      run: |
        gcloud auth configure-docker $AR_HOST
        
        # --- DEBUG LINES TO FIND THE ERROR ---
        echo "--- DEBUGGING VARIABLES ---"
        echo "GCP_PROJECT_ID is: $GCP_PROJECT_ID"
        echo "AR_HOST is: $AR_HOST"
        echo "AR_REPO is: $AR_REPO"
        echo "GITHUB_SHA is: ${GITHUB_SHA}"
        echo "---------------------------"
        # ------------------------------------
        
        # Create the full image URL
        export IMAGE_URL="$AR_HOST/$GCP_PROJECT_ID/$AR_REPO:${GITHUB_SHA}"
        
        echo "Final IMAGE_URL is: $IMAGE_URL"
        
        docker build -t $IMAGE_URL .
        docker push $IMAGE_URL
    
    - name: Deploy to GKE
      run: |
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE
        
        # Replace the placeholder in the deployment file
        sed -i "s|YOUR_IMAGE_URL|${{ env.IMAGE_URL }}|g" deployment.yml
        
        kubectl apply -f deployment.yml
