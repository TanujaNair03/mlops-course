name: CD-Pipeline (Phase 3)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Authenticate to GCP
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
    
    - name: Build, Push, and Deploy
      run: |
        # --- HARDCODE YOUR 4 VALUES HERE ---
        export GCP_PROJECT_ID="flowing-subset-444209-c9" # 1. PASTE YOUR PROJECT ID
        export GKE_CLUSTER="mlops-cluster"
        export GKE_ZONE="us-central1-a"                 # 2. PASTE YOUR GKE ZONE
        export AR_HOST="us-central1-docker.pkg.dev"    # 3. PASTE YOUR AR HOST
        export AR_REPO="mlops-repo"                      # 4. PASTE YOUR AR REPO NAME
        # ------------------------------------

        echo "--- STARTING DEPLOYMENT ---"

        # 1. Authenticate Docker
        gcloud auth configure-docker $AR_HOST

        # 2. Build and Push Docker Image
        export IMAGE_URL="$AR_HOST/$GCP_PROJECT_ID/$AR_REPO:${GITHUB_SHA}"
        echo "Building and pushing to: $IMAGE_URL"
        docker build -t $IMAGE_URL .
        docker push $IMAGE_URL

        # 3. Deploy to GKE
        echo "Deploying to GKE cluster: $GKE_CLUSTER"
        gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE
        
        # Replace the placeholder in the deployment file
        sed -i "s|YOUR_IMAGE_URL|$IMAGE_URL|g" deployment.yml
        
        kubectl apply -f deployment.yml
        echo "--- DEPLOYMENT COMPLETE ---"
